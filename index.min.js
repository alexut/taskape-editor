function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function i(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,s){return e&&i(t.prototype,e),s&&i(t,s),t}}();function clicked(t,e,s={}){return new Clicked(t,e,s)}var Clicked=function(){function n(t,e,s){var i=this;_classCallCheck(this,n),this.options=s,this.threshhold=this.options.threshhold||10,this.events={mouseclick:function(t){return i.mouseclick(t)},mousedblclick:function(t){return i.mousedblclick(t)},touchstart:function(t){return i.touchstart(t)},touchmove:function(t){return i.touchmove(t)},touchcancel:function(t){return i.touchcancel(t)},touchend:function(t){return i.touchend(t)}},t.addEventListener("click",this.events.mouseclick),t.addEventListener("dblclick",this.events.mousedblclick),t.addEventListener("touchstart",this.events.touchstart,{passive:!0}),t.addEventListener("touchmove",this.events.touchmove,{passive:!0}),t.addEventListener("touchcancel",this.events.touchcancel),t.addEventListener("touchend",this.events.touchend),this.element=t,this.callback=e,this.doubleClickCallback=this.options.doubleClickCallback}return _createClass(n,[{key:"destroy",value:function(){this.element.removeEventListener("click",this.events.mouseclick),this.element.removeEventListener("dblclick",this.events.mousedblclick),this.element.removeEventListener("touchstart",this.events.touchstart),this.element.removeEventListener("touchmove",this.events.touchmove),this.element.removeEventListener("touchcancel",this.events.touchcancel),this.element.removeEventListener("touchend",this.events.touchend)}},{key:"touchstart",value:function(t){1===t.touches.length&&(this.lastX=t.changedTouches[0].screenX,this.lastY=t.changedTouches[0].screenY,this.down=!0)}},{key:"pastThreshhold",value:function(t,e){return Math.abs(this.lastX-t)>this.threshhold||Math.abs(this.lastY-e)>this.threshhold}},{key:"touchmove",value:function(t){var e;this.down&&1===t.touches.length&&(e=t.changedTouches[0].screenX,t=t.changedTouches[0].screenY,!this.pastThreshhold(e,t))||this.touchcancel()}},{key:"touchcancel",value:function(){this.down=!1}},{key:"touchend",value:function(t){this.down&&(t.preventDefault(),this.callback)&&this.callback(t,this.options.args)}},{key:"mouseclick",value:function(t){this.callback&&this.callback(t,this.options.args)}},{key:"mousedblclick",value:function(t){this.doubleClickCallback&&this.doubleClickCallback(t,this.options.args)}}]),n}();export default clicked;let defaults={move:!0,select:!0,indentation:20,threshold:10,holdTime:1e3,expandOnClick:!1,dragOpacity:.75,prefixClassName:"mb-task",cursorName:"grab -webkit-grab pointer",cursorExpand:"pointer",edit:!0,symbols:{oracles:"#",tags:"@",actions:">"}};import*as utils from"./utils";class Indicator{constructor(t){this._indicator=utils.html(),this._indicator.style.marginLeft=t.indentation+"px";var e=utils.html({parent:this._indicator});e.style.display="flex",this._indicator.indentation=utils.html({parent:e}),this._indicator.icon=utils.html({parent:e,className:t.prefixClassName+"-expand"}),this._indicator.icon.style.height=0,this._indicator.line=utils.html({parent:e,className:t.prefixClassName+"-indicator"})}get(){return this._indicator}set _marginLeft(t){this._indicator.style.marginLeft=t+"px"}}import*as utils from"./utils";import{Indicator}from"./indicator";class Input{constructor(t){this._tree=t,this._indicator=new Indicator(t),document.body.addEventListener("mousemove",t=>this._move(t)),document.body.addEventListener("touchmove",t=>this._move(t)),document.body.addEventListener("mouseup",t=>this._up(t)),document.body.addEventListener("touchend",t=>this._up(t)),document.body.addEventListener("mouseleave",t=>this._up(t))}_down(e){if(e.target.classList.contains(this._tree.prefixClassName+"-leaf-handler")){this._target=e.currentTarget.parentNode.parentNode;let t=!1;this._tree._selection===this._target?t=!0:(this._tree._selection&&this._tree._selection.name.classList.remove(this._tree.prefixClassName+"-select"),this._tree._selection=this._target,this._tree._selection.name.classList.add(this._tree.prefixClassName+"-select")),this._isDown={x:e.pageX,y:e.pageY,alreadySelected:t};var s=utils.toGlobal(this._target);this._offset={x:e.pageX-s.x,y:e.pageY-s.y},this._tree.holdTime&&(this._holdTimeout=window.setTimeout(()=>this._hold(),this._tree.holdTime)),e.preventDefault(),e.stopPropagation()}else this._target=e.currentTarget.parentNode.parentNode,this._tree._selection!==this._target&&(this._tree._selection&&this._tree._selection.name.classList.remove(this._tree.prefixClassName+"-select"),this._tree._selection=this._target,this._tree._selection.name.classList.add(this._tree.prefixClassName+"-select"),this._tree.emit("selection-change",this._target,this._tree))}_hold(){this._holdTimeout=null,this._tree.edit(this._target)}_checkThreshold(t){return!!this._isDown&&!(!this._tree.move||!this._moving&&(!utils.distance(this._isDown.x,this._isDown.y,t.pageX,t.pageY)||(this._moving=!0,this._pickup(),0)))}_pickup(){this._holdTimeout&&(window.clearTimeout(this._holdTimeout),this._holdTimeout=null),this._tree.emit("move-pending",this._target,this._tree);var t=this._target.parentNode,e=(t.insertBefore(this._indicator.get(),this._target),utils.toGlobal(this._target));document.body.appendChild(this._target),this._old={opacity:this._target.style.opacity||"unset",position:this._target.style.position||"unset",boxShadow:this._target.name.style.boxShadow||"unset"},this._target.style.position="absolute",this._target.name.style.boxShadow="3px 3px 5px rgba(0,0,0,0.25)",this._target.style.left=e.x+"px",this._target.style.top=e.y+"px",this._target.style.opacity=this._tree.dragOpacity,0===this._tree._getChildren(t,!0).length&&this._tree._hideIcon(t)}_findClosest(t,e){var s,i;utils.toGlobal(e.name).y+e.name.offsetHeight/2<=t.pageY?this._closest.foundAbove||(utils.inside(t.pageX,t.pageY,e.name)?(this._closest.foundAbove=!0,this._closest.above=e):(s=utils.distancePointElement(t.pageX,t.pageY,e.name))<this._closest.distanceAbove&&(this._closest.distanceAbove=s,this._closest.above=e)):this._closest.foundBelow||(utils.inside(t.pageX,t.pageY,e.name)?(this._closest.foundBelow=!0,this._closest.below=e):(s=utils.distancePointElement(t.pageX,t.pageY,e.name))<this._closest.distanceBelow&&(this._closest.distanceBelow=s,this._closest.below=e));for(i of this._tree._getChildren(e))this._findClosest(t,i)}_move(t){if(this._target&&this._checkThreshold(t)){var e,s=this._tree.element,i=this._indicator.get(),n=this._tree.indentation,o=(i.remove(),this._target.style.left=t.pageX-this._offset.x+"px",this._target.style.top=t.pageY-this._offset.y+"px",utils.toGlobal(this._target.name).x);this._closest={distanceAbove:1/0,distanceBelow:1/0};for(e of this._tree._getChildren())this._findClosest(t,e);if(this._closest.above||this._closest.below)if(this._closest.above)if(this._closest.below)if(this._closest.below.parentNode===this._closest.above)this._closest.above.insertBefore(i,this._closest.below);else if(this._closest.below.parentNode===this._closest.above.parentNode)o>utils.toGlobal(this._closest.above.name).x+n?this._closest.above.insertBefore(i,this._tree._getLastChild(this._closest.above,!0)):this._closest.above.parentNode.insertBefore(i,this._closest.below);else{let e=utils.toGlobal(this._closest.above.name);if(o>e.x+n)this._closest.above.insertBefore(i,this._tree._getLastChild(this._closest.above,!0));else if(o>e.x-n)this._closest.above.parentNode.appendChild(i);else if(o<utils.toGlobal(this._closest.below.name).x)this._closest.below.parentNode.insertBefore(i,this._closest.below);else{let t=this._closest.above;for(;t.parentNode!==this._closest.below.parentNode&&o<e.x;)t=this._tree._getParent(t),e=utils.toGlobal(t.name);t.appendChild(i)}}else{let e=utils.toGlobal(this._closest.above.name);if(o>e.x+n)this._closest.above.insertBefore(i,this._tree._getFirstChild(this._closest.above,!0));else if(o>e.x-n)this._closest.above.parentNode.appendChild(i);else{let t=this._closest.above;for(;t!==s&&o<e.x;)(t=this._tree._getParent(t))!==s&&(e=utils.toGlobal(t.name));t.appendChild(i)}}else s.insertBefore(i,this._tree._getFirstChild(s));else s.appendChild(i)}}_up(t){var e;this._target&&(this._moving?((e=this._indicator.get()).parentNode.insertBefore(this._target,e),this._tree.expand(e.parentNode),this._tree._showIcon(e.parentNode),this._target.style.position="unset"===this._old.position?"":this._old.position,this._target.name.style.boxShadow="unset"===this._old.boxShadow?"":this._old.boxShadow,this._target.style.opacity="unset"===this._old.opacity?"":this._old.opacity,e.remove(),this._moveData(),this._tree.emit("move",this._target,this._tree),this._tree.emit("update",this._target,this._tree)):(!this._tree.expandOnClick||this._tree.select&&!this._isDown.alreadySelected||this._tree.toggleExpand(this._target),this._tree.emit("clicked",this._target,t,this._tree)),this._holdTimeout&&(window.clearTimeout(this._holdTimeout),this._holdTimeout=null),this._target=this._moving=null,this._isDown=null)}_moveData(){this._target.data.parent.task.splice(this._target.data.parent.task.indexOf(this._target.data),1),this._target.parentNode.data.task.splice(utils.getChildIndex(this._target.parentNode,this._target),0,this._target.data),this._target.data.parent=this._target.parentNode.data}_indicatorMarginLeft(t){this._indicator.marginLeft=t}}import Events from"eventemitter3";import clicked from"./clicked";import{Input}from"./input";import{defaults}from"./defaults";import*as utils from"./utils";class Tree extends Events{constructor(t,e){super(),this._options=utils.options(e,defaults),this._input=new Input(this),void 0===this._options.element?this.element=document.createElement("div"):this.element=utils.el(this._options.element),this._options.parent&&utils.el(this._options.parent).appendChild(this.element),this.element.classList.add(this.prefixClassName),this.element.data=t,this.update()}get selection(){return this._selection.data}set selection(t){}get prefixClassName(){return this._options.prefixClassName}set prefixClassName(t){t!==this._options.prefixClassName&&(this._options.prefixClassName=t,this.update())}get indentation(){return this._options.indentation}set indentation(t){t!==this._options.indentation&&(this._options.indentation=t,this._input._indicatorMarginLeft=t+"px",this.update())}get holdTime(){return this._options.holdTime}set holdTime(t){t!==this._options.holdTime&&(this._options.holdTime=t)}get move(){return this._options.move}set move(t){this._options.move=t}get expandOnClick(){return this._options.expandOnClick}set expandOnClick(t){this._options.expandOnClick=t}get select(){return this._options.select}set select(t){this._options.select=t}get dragOpacity(){return this._options.dragOpacity}set dragOpacity(t){this._options.dragOpacity=t}_leaf(t,e){let s=utils.html({className:this.prefixClassName+"-leaf"});s.isLeaf=!0,s.data=t,s.content=utils.html({parent:s,className:this.prefixClassName+"-content"}),s.style.marginLeft=this.indentation+"px";var i,n=this.prefixClassName+"-expand"+(t.expanded?" expanded":"");s.icon=utils.html({parent:s.content,className:n.trim()}),s.name=utils.html({parent:s.content,html:t.name,className:this.prefixClassName+"-name"}),s.handler=utils.html({parent:s.content,className:this.prefixClassName+"-leaf-handler"}),s.handler.addEventListener("mousedown",t=>this._input._down(t)),s.handler.addEventListener("touchstart",t=>this._input._down(t)),s.name.addEventListener("mousedown",t=>this._input._down(t)),s.name.addEventListener("touchstart",t=>this._input._down(t)),clicked(s.name,()=>{},{doubleClickCallback:()=>{this._options.edit&&(s.name.setAttribute("contenteditable",!0),s.name.focus())}}),s.name.addEventListener("input",t=>this._handleTagActionSuggestions(t,s)),s.name.addEventListener("blur",()=>{this._options.edit&&(t.name=s.name.innerText,s.name.removeAttribute("contenteditable"),this.emit("name-change",s,s.name.innerText,this),this.emit("update",s,this))}),t.task=t.task||[];for(i of t.task){var o=this._leaf(i,e+1);o.data.parent=t,s.appendChild(o),t.expanded||(o.style.display="none")}return 0===this._getChildren(s,!0).length&&this._hideIcon(s),clicked(s.icon,()=>this.toggleExpand(s)),this.emit("render",s,this),s}_getChildren(t,e){var s,i=[];for(s of(t=t||this.element).children)s.isLeaf&&(e||"none"!==s.style.display)&&i.push(s);return i}_hideIcon(t){t.isLeaf&&t.icon.classList.add("hidden")}_showIcon(t){t.isLeaf&&t.icon.classList.remove("hidden")}expandAll(){this._expandChildren(this.element)}_expandChildren(t){for(var e of this._getChildren(t,!0))this.expand(e),this._expandChildren(e)}collapseAll(){this._collapseChildren(this.element)}_collapseChildren(t){for(var e of this._getChildren(t,!0))this.collapse(e),this._collapseChildren(e)}toggleExpand(t){t.icon.classList.contains("hidden")||(t.data.expanded?this.collapse(t):this.expand(t))}expand(t){if(t.isLeaf){var e=this._getChildren(t,!0);if(e.length){for(var s of e)s.style.display="block";t.data.expanded=!0,t.icon.classList.add("expanded"),this.emit("expand",t,this),this.emit("update",t,this)}}}collapse(t){if(t.isLeaf){var e=this._getChildren(t,!0);if(e.length){for(var s of e)s.style.display="none";t.data.expanded=!1,t.icon.classList.remove("expanded"),this.emit("collapse",t,this),this.emit("update",t,this)}}}update(){var t,e=this.element.scrollTop;utils.removeChildren(this.element);for(t of this.element.data.task){var s=this._leaf(t,0);s.data.parent=this.element.data,this.element.appendChild(s)}this.element.scrollTop=e+"px"}editData(t){var e;for(e of this._getChildren(null,!0))e.data===t&&(e.name.setAttribute("contenteditable",!0),e.name.focus())}getLeaf(e,t=this.element){this.findInTree(t,t=>t===e)}findInTree(t,e){for(var s of t.children){if(e(s))return s;s=this.findInTree(s,e);if(s)return s}}_getFirstChild(t,e){t=this._getChildren(t,e);if(t.length)return t[0]}_getLastChild(t,e){t=this._getChildren(t,e);if(t.length)return t[t.length-1]}_getParent(t){for(t=t.parentNode;"none"===t.style.display;)t=t.parentNode;return t}_handleTagActionSuggestions(t,e){var t=t.target,s=t.innerText,i=window.getSelection().getRangeAt(0).startOffset,n=this._findLastSymbol(s,i);-1!==n&&(s=s.substring(n,i),n=this._getSuggestions(s),this._showSuggestions(n,t,i))}_findLastSymbol(e,s){var i=Object.values(this._options.symbols);for(let t=s-1;0<=t;t--)if(i.includes(e.charAt(t)))return t;return-1}_getSuggestions(t){var e=t.charAt(0);let s=t.substring(1).toLowerCase();return e===this._options.symbols.tags?Object.keys(window.suggestions.tags).filter(t=>t.startsWith(s)).flatMap(t=>window.suggestions.tags[t]):e===this._options.symbols.actions?Object.keys(window.suggestions.actions).filter(t=>t.startsWith(s)).flatMap(t=>window.suggestions.actions[t]):e===this._options.symbols.oracles?Object.keys(window.suggestions.oracles).filter(t=>t.startsWith(s)).flatMap(t=>window.suggestions.oracles[t]):[]}_showSuggestions(t,s,i){let n=document.getElementById("suggestions-list");n||((n=document.createElement("ul")).id="suggestions-list",n.style.position="absolute",document.body.appendChild(n)),n.innerHTML="",n.style.left=s.getBoundingClientRect().left+"px",n.style.top=s.getBoundingClientRect().bottom+"px",t.forEach(e=>{var t=document.createElement("li");t.innerText=e,t.addEventListener("mousedown",t=>{t.preventDefault(),this._insertSuggestion(s,e,i),n.innerHTML=""}),n.appendChild(t)})}_insertSuggestion(t,e,s){var i=t.innerText,n=i.charAt(s-1);i.substring(0,s-1),i.substring(s);let o=document.createElement("span");o.className="suggestion-span",o.contentEditable="false",o.innerHTML=""+n+e+' <span class="remove-suggestion">x</span>',o.querySelector(".remove-suggestion").addEventListener("click",()=>{o.remove()});i=window.getSelection().getRangeAt(0),i.deleteContents(),i.insertNode(o),s=document.createTextNode(" "),i.insertNode(s),i.setStartAfter(s),i.setEndAfter(s),window.getSelection().removeAllRanges(),window.getSelection().addRange(i),n=new Event("input",{bubbles:!0,cancelable:!0});t.dispatchEvent(n),t.focus()}}function el(t){return"string"==typeof t?document.querySelector(t):t}function distance(t,e,s,i){return Math.sqrt(Math.pow(t-s,2)+Math.pow(e-i,2))}function distancePointElement(t,e,s){var i=toGlobal(s),n=s.offsetWidth,s=s.offsetHeight,o=i.x+n/2,i=i.y+s/2,t=Math.max(Math.abs(t-o)-n/2,0),o=Math.max(Math.abs(e-i)-s/2,0);return t*t+o*o}function inside(t,e,s){var i=toGlobal(s),n=i.x,i=i.y,o=s.offsetWidth;return n<=t&&t<=n+o&&i<=e&&e<=i+s.offsetHeight}function toGlobal(t){var t=t.getBoundingClientRect(),e=document.body,s=document.documentElement,i=window.pageYOffset||s.scrollTop||e.scrollTop,n=window.pageXOffset||s.scrollLeft||e.scrollLeft,o=s.clientTop||e.clientTop||0,s=s.clientLeft||e.clientLeft||0,e=t.top+i-o,i=t.left+n-s;return{y:Math.round(e),x:Math.round(i)}}function options(t,e){for(var s in t=t||{},e)t[s]=(void 0!==t[s]?t:e)[s];return t}function style(t,e,s){if(Array.isArray(s)){for(var i of s)if(t.style[e]=i,t.style[e]===i)break}else t.style[e]=s}function percentage(t,e,s,i,n,o,a,l){var r=(s-t)*(i-e),h=(a-n)*(l-o),s=Math.max(0,Math.min(s,a)-Math.max(t,n))*Math.max(0,Math.min(i,l)-Math.max(e,o)),a=r+h-s;return 0!=a?s/a:0}function removeChildren(t){for(;t.firstChild;)t.firstChild.remove()}function html(t){t=t||{};var e=document.createElement(t.type||"div");if(t.parent&&t.parent.appendChild(e),t.className&&e.classList.add(t.className),t.html&&(e.innerHTML=t.html),t.id&&(e.id=t.id),t.attributes)for(var s in t.attributes)e.setAttribute(s,t.attributes[s]);return e}function getChildIndex(t,e){let s=0;for(var i of t.children){if(i===e)return s;s++}return-1}function attachStyles(t){var e=document.createElement("style");e.innerHTML=t,document.head.appendChild(e)}export{defaults,Indicator,Input,Tree,el,distance,distancePointElement,inside,toGlobal,options,style,percentage,removeChildren,html,getChildIndex,attachStyles};